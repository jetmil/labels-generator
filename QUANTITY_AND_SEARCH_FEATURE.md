# Новые возможности: Количество копий и Поиск

**Дата:** 2025-12-05
**Версия:** 1.1

## Что добавлено

### 1. Указание количества копий для печати

Теперь каждой свече можно задать количество копий, которые будут напечатаны при генерации этикеток.

**Как использовать:**

1. При создании или редактировании свечи найдите поле **"Количество копий для печати"**
2. Укажите число от 1 до 100 (по умолчанию = 1)
3. При генерации этикеток свеча будет продублирована указанное количество раз

**Пример:**

```
Свеча: ОЧИЩЕНИЕ
Количество: 3

Результат генерации:
- 3 этикетки с названием "ОЧИЩЕНИЕ"
- 3 инструкции с названием "ОЧИЩЕНИЕ"
```

**Технические детали:**

- Поле в базе данных: `quantity INTEGER DEFAULT 1`
- Генератор этикеток автоматически дублирует свечи согласно количеству
- Каждая копия размещается на странице этикеток (9 шт/страница) и инструкций (4 шт/страница)

### 2. Поиск свечей по названию

Добавлена возможность быстрого поиска свечей в каталоге по названию.

**Как использовать:**

1. В верхней части каталога найдите поле **"Поиск по названию свечи..."**
2. Начните вводить название свечи
3. Список автоматически отфильтруется в реальном времени
4. Нажмите кнопку **"Сбросить"** для очистки поиска

**Особенности:**

- Поиск регистронезависимый (можно искать как "ОЧИЩЕНИЕ", так и "очищение")
- Поиск по частичному совпадению (можно искать "очищ" и найдется "ОЧИЩЕНИЕ")
- Работает вместе с сортировкой и фильтрами

**Пример:**

```
Поиск: "любов"
Результаты:
- ЛЮБОВНЫЙ ВИХРЬ
- СВЕЧА ЛЮБВИ
- ЛЮБОВНАЯ ЗАЩИТА
```

## API изменения

### Backend (Python FastAPI)

**Новые поля в модели Candle:**

```python
# models.py
quantity = Column(Integer, default=1)
```

**Обновленный эндпоинт GET /api/candles:**

```python
@app.get("/api/candles", response_model=List[schemas.Candle])
def get_candles(
    ...
    search: Optional[str] = None,  # ← Новый параметр
    ...
):
    # Поиск по названию (регистронезависимый)
    if search:
        query = query.filter(Candle.name.ilike(f"%{search}%"))
```

**Генератор этикеток:**

```python
# label_generator.py

# Создаём расширенный список свечей с учётом количества копий
expanded_candles = []
for candle in candles:
    quantity = getattr(candle, 'quantity', 1) or 1
    for _ in range(quantity):
        expanded_candles.append(candle)
```

### Frontend (Next.js + TypeScript)

**Обновленный интерфейс Candle:**

```typescript
// lib/api.ts
export interface Candle {
  ...
  quantity: number;  // ← Новое поле
  ...
}
```

**Компонент формы:**

```typescript
// components/CandleForm.tsx

<div>
  <label>Количество копий для печати</label>
  <input
    type="number"
    min="1"
    max="100"
    value={formData.quantity}
    onChange={(e) => setFormData(prev => ({
      ...prev,
      quantity: parseInt(e.target.value) || 1
    }))}
  />
  <p className="text-xs text-gray-400">
    При генерации этикеток эта свеча будет продублирована указанное количество раз
  </p>
</div>
```

**Главная страница с поиском:**

```typescript
// app/page.tsx

const [searchQuery, setSearchQuery] = useState('');

const { data: candles } = useQuery({
  queryKey: ['candles', sortBy, sortOrder, searchQuery],
  queryFn: () => candleApi.getAll({
    sort_by: sortBy,
    sort_order: sortOrder,
    search: searchQuery || undefined,
  }),
});

<input
  type="text"
  value={searchQuery}
  onChange={(e) => setSearchQuery(e.target.value)}
  placeholder="Поиск по названию свечи..."
/>
```

## База данных

**Миграция:**

```sql
-- Добавление колонки quantity
ALTER TABLE candles ADD COLUMN IF NOT EXISTS quantity INTEGER DEFAULT 1;

-- Установка значения по умолчанию для существующих записей
UPDATE candles SET quantity = 1 WHERE quantity IS NULL;
```

## Часто задаваемые вопросы

**Q: Можно ли указать количество больше 100?**
A: Нет, в интерфейсе максимум ограничен 100 копиями для предотвращения слишком больших файлов.

**Q: Как количество влияет на размер файла?**
A: Каждая копия увеличивает размер HTML файла. Для больших количеств (>50) рекомендуется генерировать несколько раз.

**Q: Поиск ищет только по названию?**
A: Да, в текущей версии поиск работает только по полю `name`. Поиск по описанию и другим полям можно добавить в будущем.

**Q: Работает ли поиск с кириллицей?**
A: Да, поиск корректно работает с русскими буквами благодаря использованию `ilike` в PostgreSQL.

**Q: Можно ли искать по нескольким словам?**
A: Да, поиск "СВЕЧА ОЧИЩ" найдет "СВЕЧА ОЧИЩЕНИЯ".

## Тестирование

**Проверка поля quantity:**

```bash
# Получить все свечи и проверить наличие quantity
curl -s "http://192.168.0.95:8201/api/candles" | jq '.[0] | {name, quantity}'
```

**Проверка поиска:**

```bash
# Поиск по слову "любов"
curl -s "http://192.168.0.95:8201/api/candles?search=любов" | jq '.[].name'
```

**Проверка генерации с количеством:**

```python
import requests

# Установить quantity=3 для свечи с ID=1
requests.put("http://192.168.0.95:8201/api/candles/1", json={"quantity": 3})

# Сгенерировать этикетки
response = requests.post(
    "http://192.168.0.95:8201/api/generate-labels",
    json={"candle_ids": [1], "format": "html"}
)

# Проверить, что в HTML 3 этикетки и 3 инструкции
html = response.text
print(f"Label cards: {html.count('class=\"label\"')}")  # Должно быть 3
print(f"Instruction cards: {html.count('class=\"instruction-card\"')}")  # Должно быть 3
```

## Известные ограничения

1. **Максимум 100 копий** - жесткое ограничение в интерфейсе
2. **Поиск только по названию** - не ищет в описании, практике и других полях
3. **Нет поиска по категории** - в текущей версии поиск не фильтрует категории

## Планы на будущее

- [ ] Расширенный поиск по всем полям (описание, практика, теги)
- [ ] Фильтр по категории + поиск одновременно
- [ ] Быстрое копирование свечей (кнопка "Дублировать")
- [ ] Массовое изменение количества для выбранных свечей

---

*Документация создана: 2025-12-05 | Claude Code Assistant*
